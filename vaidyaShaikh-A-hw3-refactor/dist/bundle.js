(()=>{"use strict";var e,t,n=null,o=null,r=null,a=null,l=null,c=null,i=null,s=Object.freeze({gain:.5,numSamples:256,bassFreq:100,trebleFreq:3e3,bassGain:0,trebleGain:0}),u=(new Uint8Array(s.numSamples/2),function(e){o&&(o.src=e)}),h=function(e){var t=Number(e);l&&(l.gain.value=t)},d=function(e){c&&(c.gain.value=Number(e))},v=function(e){i&&(i.gain.value=Number(e))},f=null,m=null,b=null,g=null,y=[],p=function(){function n(e){var t=e.x,n=e.y,o=e.r,r=void 0===o?12:o,a=e.hue,l=void 0===a?200:a,c=e.vx,i=void 0===c?0:c,s=e.vy,u=void 0===s?0:s;this.x=t,this.y=n,this.r=r,this.hue=l,this.vx=i,this.vy=u,this.pulse=0,this.switch=!1}return n.prototype.update=function(n){var o=n.avg,r=n.bass,a=n.treble,l=n.beat;this.pulse=.85*this.pulse+.15*r,this.r=10+30*this.pulse,this.hue=(this.hue+6*a)%360,l&&(this.switch=!this.switch);var c=.5+o;this.x+=this.vx*c,this.y+=this.vy*c,this.x<-this.r&&(this.x=e+this.r),this.x>e+this.r&&(this.x=-this.r),this.y<-this.r&&(this.y=t+this.r),this.y>t+this.r&&(this.y=-this.r)},n.prototype.draw=function(e){e.save(),e.globalCompositeOperation="lighter",e.shadowBlur=8+24*this.pulse,e.shadowColor="hsl(".concat(this.hue,", 80%, 60%)"),e.beginPath(),e.arc(this.x,this.y,this.r,0,2*Math.PI),this.switch?(e.fillStyle="hsla(".concat(this.hue,", 85%, 55%, 0.75)"),e.fill()):(e.lineWidth=2,e.strokeStyle="hsla(".concat(this.hue,", 85%, 70%, 0.9)"),e.stroke()),e.restore()},n}(),w=0,S=function(){if(!f)throw new Error("Canvas context not initialized");var e=f.createLinearGradient(0,0,0,t);return e.addColorStop(0,"#051026"),e.addColorStop(.5,"#0b234a"),e.addColorStop(1,"#081a35"),e},q=function(e,t,n,o,r){if(f){var a=Math.min(r,.5*n,.5*Math.abs(o));f.beginPath(),f.moveTo(e+a,t),f.arcTo(e+n,t,e+n,t+o,a),f.arcTo(e+n,t+o,e,t+o,a),f.arcTo(e,t+o,e,t,a),f.arcTo(e,t,e+n,t,a),f.closePath()}},x=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function l(e){try{i(o.next(e))}catch(e){a(e)}}function c(e){try{i(o.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(l,c)}i((o=o.apply(e,t||[])).next())})},C=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},l=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return l.next=c(0),l.throw=c(1),l.return=c(2),"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function c(c){return function(i){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;l&&(l=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&c[0]?o.return:c[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,c[1])).done)return r;switch(o=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){a.label=c[1];break}if(6===c[0]&&a.label<r[1]){a.label=r[1],r=c;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(c);break}r[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],o=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,i])}}},k=null,M={showGradient:!0,showBars:!0,showCircles:!0,showNoise:!1,showInvert:!1,showEmboss:!1,useWaveform:!1},E=1e3/60,A=function(){return x(void 0,void 0,void 0,function(){var w,q,E,A,T,G,I,N,z,O,R,P,j,W,D,L,U,H,V,J,K,Q,X,Y,Z,$,_,ee,te;return C(this,function(ne){switch(ne.label){case 0:return ne.trys.push([0,2,,3]),[4,x(void 0,void 0,void 0,function(){var e;return C(this,function(t){switch(t.label){case 0:return[4,fetch("data/av-data.json")];case 1:if(!(e=t.sent()).ok)throw new Error("Failed to load app data: ".concat(e.status));return[2,e.json()]}})})];case 1:return k=ne.sent(),[3,3];case 2:return w=ne.sent(),console.error(w),k={title:"Audio Visualizer",tracks:[{file:"media/New Adventure Theme.mp3",name:"New Adventure Theme"}],start:{trackIndex:0,volume:1,ui:{}}},[3,3];case 3:return k?(k.title&&(document.title=k.title,(q=document.querySelector("#app-title"))&&(q.textContent=k.title)),(E=document.querySelector("#app-instructions"))&&k.instructions&&(E.textContent=k.instructions),A=document.querySelector("#select-track"),T=null!==(Y=k.start)&&void 0!==Y?Y:{},G=null!==(Z=T.trackIndex)&&void 0!==Z?Z:0,A&&Array.isArray(k.tracks)&&(A.innerHTML="",k.tracks.forEach(function(e,t){var n,o=document.createElement("option");o.value=e.file,o.textContent=null!==(n=e.name)&&void 0!==n?n:e.file,t===G&&(o.selected=!0),A.appendChild(o)})),re=null!==(ee=null===(_=null===($=k.tracks)||void 0===$?void 0:$[G])||void 0===_?void 0:_.file)&&void 0!==ee?ee:"media/New Adventure Theme.mp3",ae=window.AudioContext||window.webkitAudioContext,n=new ae,o=new Audio,u(re),n&&o&&(r=n.createMediaElementSource(o),(a=n.createAnalyser()).fftSize=s.numSamples,(c=n.createBiquadFilter()).type="lowshelf",c.frequency.value=s.bassFreq,c.gain.value=s.bassGain,(i=n.createBiquadFilter()).type="highshelf",i.frequency.value=s.trebleFreq,i.gain.value=s.trebleGain,(l=n.createGain()).gain.value=s.gain,r.connect(c),c.connect(i),i.connect(a),a.connect(l),l.connect(n.destination)),console.log("init called"),console.log("Testing utils.getRandomColor() import: ".concat("rgba(".concat((oe=function(){return 185*Math.random()+35})(),",").concat(oe(),",").concat(oe(),",1)"))),I=document.querySelector("canvas"),N=null!==(te=T.ui)&&void 0!==te?te:{},Object.assign(M,N),z=document.querySelector("#slider-volume"),O=document.querySelector("#label-volume"),z&&(R="number"==typeof T.volume?T.volume:1,z.value=String(R),h(R),O&&(O.textContent=String(Math.round(R/2*100)))),T.eq&&(P=T.eq,j=P.bassGain,W=void 0===j?0:j,D=P.trebleGain,L=void 0===D?0:D,d(W),v(L),U=document.querySelector("#slider-bass"),H=document.querySelector("#slider-treble"),V=document.querySelector("#label-bass"),J=document.querySelector("#label-treble"),U&&(U.value=String(W)),H&&(H.value=String(L)),V&&(V.textContent="".concat(W," dB")),J&&(J.textContent="".concat(L," dB"))),(K=function(e,t){var n=document.querySelector(e);n&&"boolean"==typeof N[t]&&(n.checked=N[t],t in M&&(M[t]=N[t]))})("#cb-gradient","showGradient"),K("#cb-bars","showBars"),K("#cb-circles","showCircles"),K("#cb-noise","showNoise"),K("#cb-invert","showInvert"),K("#cb-emboss","showEmboss"),(Q=document.querySelectorAll('input[name="viz-mode"]')).length&&(X=M.useWaveform?"waveform":"frequency",Q.forEach(function(e){e.checked=e.value===X})),B(I),I&&a?(function(n,o){var r=n.getContext("2d");if(r){f=r,e=n.width,t=n.height,m=S(),b=o,g=new Uint8Array(b.fftSize/2),y=[];for(var a=0;a<10;a++)y.push(new p({x:Math.random()*e,y:Math.random()*t,r:8+14*Math.random(),hue:180+60*Math.random(),vx:.8*(2*Math.random()-1),vy:.8*(2*Math.random()-1)}))}}(I,a),F()):console.error("Canvas element or analyser node not available"),[2]):[2]}var oe,re,ae})})},F=function(){(function(n){if(void 0===n&&(n={}),b&&g&&f){b.getByteFrequencyData(g);for(var o=function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];var o=t/(255*e.length),r=Math.max(1,Math.floor(e.length/8)),a=0,l=0;for(n=0;n<r;n++)a+=e[n];for(n=e.length-r;n<e.length;n++)l+=e[n];var c=o>.28&&w<=.28;return w=o,{avg:o,bass:a/(255*r),treble:l/(255*r),beat:c}}(g),r=0,a=y;r<a.length;r++)a[r].update(o);for(var l=0,c=y;l<c.length;l++)c[l].draw(f);f.save(),f.globalCompositeOperation="source-over",f.fillStyle="#000",f.globalAlpha=.15,f.fillRect(0,0,e,t),f.restore(),n.showGradient&&(m=S(),f.save(),f.fillStyle=m,f.globalAlpha=.9,f.fillRect(0,0,e,t),f.restore());var i=function(){if(!g)return 0;for(var e=0,t=0;t<g.length;t++)e+=g[t];return e/(255*g.length)}(),s=8+Math.floor(24*i),u=205,h=80+Math.floor(20*i),d=50+Math.floor(10*i);if(n.showBars){var v=e-40,p=Math.max(2,(v-3*(g.length-1))/g.length),x=.72*t;f.save(),f.globalCompositeOperation="lighter",f.shadowBlur=s,f.shadowColor="hsl(".concat(u,", ").concat(h,"%, ").concat(d+15,"%)");for(var C=0;C<g.length;C++){var k=g[C]/255,M=Math.pow(k,1.3)*t*.45,E=20+C*(p+3),A=x-M;f.fillStyle="hsl(".concat(u+.08*C,", ").concat(h,"%, ").concat(40+35*k,"%)"),q(E,A,p,M,Math.min(6,.5*p)),f.fill()}f.restore()}if(n.showCircles){var F=e/2,B=t/2,T=20+60*i;f.save(),f.globalCompositeOperation="lighter",f.lineWidth=2+3*i,f.shadowBlur=s+6,f.shadowColor="hsl(".concat(u,", ").concat(h,"%, ").concat(d+10,"%)");for(var G=0;G<5;G++){var I=T+G*(.08*t);f.beginPath(),f.arc(F,B,I,0,2*Math.PI),f.strokeStyle="hsla(".concat(u+3*G,", ").concat(h,"%, ").concat(55-4*G,"%, ").concat(.28+.4*i,")"),f.stroke()}f.restore()}F=e/2,B=.42*t;var N=t*(.12+.22*i),z=Math.max(2,Math.floor(g.length/64));for(f.save(),f.globalCompositeOperation="lighter",f.lineWidth=2,f.strokeStyle="hsla(".concat(195,", ").concat(h,"%, ").concat(60+10*i,"%, 0.85)"),f.shadowBlur=s+4,f.shadowColor="hsl(".concat(u,", ").concat(h,"%, ").concat(d+15,"%)"),f.beginPath(),f.moveTo(0,B),C=0;C<g.length;C+=z){E=C/(g.length-1)*e,A=B-2*(g[C]/255-.5)*N;var O=E-e/(g.length/z)*.5,R=.5*(B+A);f.quadraticCurveTo(O,R,E,A)}if(f.stroke(),f.restore(),n.showNoise||n.showInvert||n.showEmboss){var P=f.getImageData(0,0,e,t),j=P.data,W=j.length;for(C=0;C<W;C+=4)if(n.showNoise&&Math.random()<.035&&(j[C]=80+70*Math.random(),j[C+1]=120+80*Math.random(),j[C+2]=255),n.showInvert){G=j[C];var D=j[C+1],L=j[C+2];j[C]=255-G,j[C+1]=255-D,j[C+2]=255-L}if(n.showEmboss){var U=new Uint8ClampedArray(j),H=4*P.width;for(C=0;C<W;C++)if(C%4!=3)if((C+4)%H===0||C>=W-H)j[C]=127;else{var V=127+2*U[C]-U[C+4]-U[C+H];j[C]=V<0?0:V>255?255:V}}f.putImageData(P,0,0)}}})(M),setTimeout(F,E)},B=function(e){var t=document.querySelector("#btn-fullscreen");t&&(t.onclick=function(){console.log("goFullscreen() called"),function(e){if(e){var t=e;e.requestFullscreen?e.requestFullscreen():t.mozRequestFullscreen?t.mozRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen()}}(e)});var r=document.querySelector("#btn-play");r&&(r.onclick=function(e){var t=n;if(t){console.log("audioCtx.state before = ".concat(t.state)),"suspended"===t.state&&t.resume(),console.log("audioCtx.state after = ".concat(t.state));var r=e.currentTarget;"no"===r.dataset.playing?(o&&o.play(),r.dataset.playing="yes"):(o&&o.pause(),r.dataset.playing="no")}});var a=document.querySelector("#slider-volume"),l=document.querySelector("#label-volume");a&&(a.oninput=function(e){var t=e.target.value;if(h(t),l){var n=Number(t);l.textContent=String(Math.round(n/2*100))}});var c=document.querySelector("#select-track");c&&(c.onchange=function(e){var t=e.target;u(t.value),r&&"yes"===r.dataset.playing&&(r.dispatchEvent(new MouseEvent("click")),r.dispatchEvent(new MouseEvent("click")))});var i=document.querySelector("#cb-noise");i&&(i.onchange=function(e){var t=e.target;M.showNoise=t.checked});var s=document.querySelector("#cb-invert");s&&(s.onchange=function(e){var t=e.target;M.showInvert=t.checked});var f=document.querySelector("#cb-emboss");f&&(f.onchange=function(e){var t=e.target;M.showEmboss=t.checked});var m=document.querySelector("#cb-gradient");m&&(m.onchange=function(e){var t=e.target;M.showGradient=t.checked});var b=document.querySelector("#cb-bars");b&&(b.onchange=function(e){var t=e.target;M.showBars=t.checked});var g=document.querySelector("#cb-circles");g&&(g.onchange=function(e){var t=e.target;M.showCircles=t.checked});var y=document.querySelector("#slider-bass"),p=document.querySelector("#label-bass");y&&(y.oninput=function(e){var t=e.target;d(t.value),p&&(p.textContent="".concat(t.value," dB"))});var w=document.querySelector("#slider-treble"),S=document.querySelector("#label-treble");w&&(w.oninput=function(e){var t=e.target;v(t.value),S&&(S.textContent="".concat(t.value," dB"))});var q=document.querySelectorAll('input[name="viz-mode"]');q&&q.length&&q.forEach(function(e){e.addEventListener("change",function(e){var t=e.target;M.useWaveform="waveform"===t.value})})};window.onload=function(){console.log("window.onload called"),A()}})();